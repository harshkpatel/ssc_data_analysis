<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Analytics Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <style>
        .wordcloud-img { max-width: 100%; height: auto; }
        .dropdown-toggle::after { margin-left: 0.5em; }
        .card { margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Email Analytics</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Controls Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body d-flex align-items-center">
                        <label for="stream-filter" class="form-label mb-0 me-2">Stream:</label>
                        <select id="stream-filter" class="form-select w-auto me-3">
                            <option value="">All Streams</option>
                            <option value="MPS">MPS</option>
                            <option value="LS">LS</option>
                            <option value="RC">RC</option>
                            <option value="SS">SS</option>
                            <option value="HUM">HUM</option>
                            <option value="CS">CS</option>
                        </select>
                        <label for="source-filter" class="form-label mb-0 me-2">Data Source:</label>
                        <select id="source-filter" class="form-select w-auto">
                            <option value="Harsh_all">Harsh_all</option>
                            <option value="fake_uoft_emails">fake_uoft_emails</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!-- Analytics Widgets -->
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Overall Statistics</h5>
                        <ul class="list-group list-group-flush" id="overall-stats-list"></ul>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">Email Volume Over Time</h5>
                            <select id="volume-period" class="form-select w-auto">
                                <option value="days">Days</option>
                                <option value="weeks">Weeks</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                        <canvas id="volumeChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">Sentiment Over Time</h5>
                            <select id="sentiment-period" class="form-select w-auto">
                                <option value="days">Days</option>
                                <option value="weeks">Weeks</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                        <canvas id="sentimentChart" height="80"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">Word Cloud</h5>
                            <select id="wordcloud-type" class="form-select w-auto">
                                <option value="raw">Raw Emails</option>
                                <option value="classified">Classified Emails</option>
                            </select>
                        </div>
                        <img id="wordcloud-img" class="wordcloud-img mb-2" src="" alt="Word Cloud">
                        <div>
                            <strong>Top Keywords:</strong>
                            <ul id="top-keywords" class="mb-0"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Sentiment Distribution</h5>
                        <canvas id="sentimentDistChart" height="80"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Email Categories</h5>
                        <ul id="category-list" class="list-group list-group-flush"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS (for navbar toggling) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Utility to fetch JSON
    async function fetchJSON(url) {
        const res = await fetch(url);
        return await res.json();
    }

    // Get current stream and source filter
    function getStreamFilter() {
        return document.getElementById('stream-filter').value;
    }
    function getSourceFilter() {
        return document.getElementById('source-filter').value;
    }

    // Add stream and source parameter to URL if filter is set
    function addParams(url) {
        const stream = getStreamFilter();
        const source = getSourceFilter();
        let params = [];
        if (stream) params.push('stream=' + encodeURIComponent(stream));
        if (source) params.push('source=' + encodeURIComponent(source));
        if (params.length > 0) {
            const separator = url.includes('?') ? '&' : '?';
            return url + separator + params.join('&');
        }
        return url;
    }

    // Overall stats
    async function loadOverallStats() {
        const url = addParams('/api/overall_stats');
        const stats = await fetchJSON(url);
        const list = document.getElementById('overall-stats-list');
        list.innerHTML = '';
        if (stats.error) {
            list.innerHTML = `<li class="list-group-item text-danger">${stats.error}</li>`;
            return;
        }
        list.innerHTML += `<li class="list-group-item">Total Emails: <b>${stats.total_emails}</b></li>`;
        list.innerHTML += `<li class="list-group-item">Date Range: <b>${stats.date_range[0]}</b> to <b>${stats.date_range[1]}</b></li>`;
        if (stats.unique_senders !== undefined) {
            list.innerHTML += `<li class="list-group-item">Unique Senders: <b>${stats.unique_senders}</b></li>`;
        }
    }

    // Email volume timeline
    let volumeChart;
    async function loadVolumeChart(period) {
        const url = addParams(`/api/email_volume_timeline?period=${period}`);
        const data = await fetchJSON(url);
        const ctx = document.getElementById('volumeChart').getContext('2d');
        if (volumeChart) volumeChart.destroy();
        volumeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.time,
                datasets: [{
                    label: 'Emails',
                    data: data.count,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {responsive: true, plugins: {legend: {display: false}}}
        });
    }
    document.getElementById('volume-period').addEventListener('change', e => {
        loadVolumeChart(e.target.value);
    });

    // Sentiment over time
    let sentimentChart;
    async function loadSentimentChart(period) {
        const url = addParams(`/api/sentiment_over_time?period=${period}`);
        const data = await fetchJSON(url);
        const ctx = document.getElementById('sentimentChart').getContext('2d');
        if (sentimentChart) sentimentChart.destroy();
        sentimentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.time,
                datasets: [{
                    label: 'Avg Sentiment',
                    data: data.avg_polarity,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40,167,69,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {responsive: true, plugins: {legend: {display: false}}}
        });
    }
    document.getElementById('sentiment-period').addEventListener('change', e => {
        loadSentimentChart(e.target.value);
    });

    // Word cloud
    async function loadWordCloud(type) {
        let url = type === 'classified' ? '/api/classified_word_cloud' : '/api/word_cloud';
        url = addParams(url);
        const data = await fetchJSON(url);
        document.getElementById('wordcloud-img').src = 'data:image/png;base64,' + data.wordcloud;
        const topList = document.getElementById('top-keywords');
        topList.innerHTML = '';
        (data.top_keywords || []).forEach(([word, count]) => {
            topList.innerHTML += `<li>${word} <span class="badge bg-secondary">${count}</span></li>`;
        });
    }
    document.getElementById('wordcloud-type').addEventListener('change', e => {
        loadWordCloud(e.target.value);
    });

    // Sentiment distribution
    let sentimentDistChart;
    async function loadSentimentDist() {
        const url = addParams('/api/sentiment_distribution');
        const data = await fetchJSON(url);
        const ctx = document.getElementById('sentimentDistChart').getContext('2d');
        if (sentimentDistChart) sentimentDistChart.destroy();
        sentimentDistChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    data: Object.values(data),
                    backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                }]
            },
            options: {responsive: true, plugins: {legend: {position: 'bottom'}}}
        });
    }

    // Email categories
    async function loadCategories() {
        const url = addParams('/api/email_categories');
        const data = await fetchJSON(url);
        const list = document.getElementById('category-list');
        list.innerHTML = '';
        if (data.error) {
            list.innerHTML = `<li class="list-group-item text-danger">${data.error}</li>`;
            return;
        }
        Object.entries(data.category_counts).forEach(([cat, count]) => {
            const desc = data.category_descriptions[cat] || '';
            list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <span><b>${cat.replace('_', ' ').toUpperCase()}</b><br><small>${desc}</small></span>
                <span class="badge bg-primary rounded-pill">${count}</span>
            </li>`;
        });
    }

    // Reload all data when stream or source filter changes
    function reloadAllData() {
        loadOverallStats();
        loadVolumeChart(document.getElementById('volume-period').value);
        loadSentimentChart(document.getElementById('sentiment-period').value);
        loadWordCloud(document.getElementById('wordcloud-type').value);
        loadSentimentDist();
        loadCategories();
    }

    // Stream/source filter change handler
    document.getElementById('stream-filter').addEventListener('change', reloadAllData);
    document.getElementById('source-filter').addEventListener('change', reloadAllData);

    // Initial load
    window.addEventListener('DOMContentLoaded', () => {
        reloadAllData();
    });
    </script>
</body>
</html> 